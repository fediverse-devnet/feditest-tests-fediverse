<!DOCTYPE html>
<html lang="en" dir="ltr"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><style>dfn{cursor:pointer}
.dfn-panel{position:absolute;z-index:35;min-width:300px;max-width:500px;padding:.5em .75em;margin-top:.6em;font-family:"Helvetica Neue",sans-serif;font-size:small;background:#fff;background:var(--indextable-hover-bg,#fff);color:#000;color:var(--text,#000);box-shadow:0 1em 3em -.4em rgba(0,0,0,.3),0 0 1px 1px rgba(0,0,0,.05);box-shadow:0 1em 3em -.4em var(--tocsidebar-shadow,rgba(0,0,0,.3)),0 0 1px 1px var(--tocsidebar-shadow,rgba(0,0,0,.05));border-radius:2px}
.dfn-panel:not(.docked)>.caret{position:absolute;top:-9px}
.dfn-panel:not(.docked)>.caret::after,.dfn-panel:not(.docked)>.caret::before{content:"";position:absolute;border:10px solid transparent;border-top:0;border-bottom:10px solid #fff;border-bottom-color:var(--indextable-hover-bg,#fff);top:0}
.dfn-panel:not(.docked)>.caret::before{border-bottom:9px solid #a2a9b1;border-bottom-color:var(--indextable-hover-bg,#a2a9b1)}
.dfn-panel *{margin:0}
.dfn-panel b{display:block;color:#000;color:var(--text,#000);margin-top:.25em}
.dfn-panel ul a[href]{color:#333;color:var(--text,#333)}
.dfn-panel>div{display:flex}
.dfn-panel a.self-link{font-weight:700;margin-right:auto}
.dfn-panel .marker{padding:.1em;margin-left:.5em;border-radius:.2em;text-align:center;white-space:nowrap;font-size:90%;color:#040b1c}
.dfn-panel .marker.dfn-exported{background:#d1edfd;box-shadow:0 0 0 .125em #1ca5f940}
.dfn-panel .marker.idl-block{background:#8ccbf2;box-shadow:0 0 0 .125em #0670b161}
.dfn-panel a:not(:hover){text-decoration:none!important;border-bottom:none!important}
.dfn-panel a[href]:hover{border-bottom-width:1px}
.dfn-panel ul{padding:0}
.dfn-panel li{margin-left:1em}
.dfn-panel.docked{position:fixed;left:.5em;top:unset;bottom:2em;margin:0 auto;max-width:calc(100vw - .75em * 2 - .5em - .2em * 2);max-height:30vh;overflow:auto}</style><link rel="preconnect" crossorigin="anonymous" href="https://www.w3.org/" class="removeOnSave"><link rel="preload" as="script" href="ActivityPub%20and%20HTTP%20Signatures_files/fixup.js" class="removeOnSave"><link rel="preload" as="style" href="ActivityPub%20and%20HTTP%20Signatures_files/base.css" class="removeOnSave"><link rel="preload" as="style" href="https://www.w3.org/StyleSheets/TR/2021/dark.css" class="removeOnSave"><link rel="preload" as="image" crossorigin="anonymous" href="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" class="removeOnSave"><link rel="stylesheet" href="ActivityPub%20and%20HTTP%20Signatures_files/base.css" class="removeOnSave">
    <meta charset="utf-8">
    <title>ActivityPub and HTTP Signatures</title>


  <style id="respec-ui-styles" class="removeOnSave">.respec-modal .close-button{position:absolute;z-index:inherit;padding:.2em;font-weight:700;cursor:pointer;margin-left:5px;border:none;background:0 0}
#respec-ui{position:fixed;display:flex;flex-direction:row-reverse;top:20px;right:20px;width:202px;text-align:right;z-index:9000}
#respec-pill,.respec-info-button{height:2.4em;background:#fff;background:var(--bg,#fff);color:#787878;color:var(--tocnav-normal-text,#787878);border:1px solid #ccc;box-shadow:1px 1px 8px 0 rgba(100,100,100,.5);box-shadow:1px 1px 8px 0 var(--tocsidebar-shadow,rgba(100,100,100,.5));padding:.2em 0}
.respec-info-button{border:none;opacity:.75;border-radius:2em;margin-right:1em;min-width:3.5em;will-change:opacity}
.respec-info-button:focus,.respec-info-button:hover{opacity:1;transition:opacity .2s}
#respec-pill{width:4.8em}
#respec-pill:not(:disabled){animation:respec-fadein .6s ease-in-out}
@keyframes respec-fadein{
from{margin-top:-1.2em;border-radius:50%;border:.2em solid rgba(100,100,100,.5);box-shadow:none;height:4.8em}
to{margin-top:0;border:1px solid #ccc;border-radius:0;box-shadow:1px 1px 8px 0 rgba(100,100,100,.5);height:2.4em}
}
#respec-pill:disabled{margin-top:-1.2em;position:relative;border:none;box-shadow:none;border-radius:50%;width:4.8em;height:4.8em;padding:0}
#respec-pill:disabled::after{position:absolute;content:'';inset:-.2em;border-radius:50%;border:.2em solid rgba(100,100,100,.5);border-left:.2em solid transparent;animation:respec-spin .5s infinite linear}
@media (prefers-reduced-motion){
#respec-pill:not(:disabled){animation:none}
#respec-pill:disabled::after{animation:none;border-left:.2em solid rgba(100,100,100,.5)}
}
@keyframes respec-spin{
0%{transform:rotate(0)}
100%{transform:rotate(360deg)}
}
.respec-hidden{visibility:hidden;opacity:0;transition:visibility 0s .2s,opacity .2s linear}
.respec-visible{visibility:visible;opacity:1;transition:opacity .2s linear}
#respec-pill:focus,#respec-pill:hover{color:#000;background-color:#f5f5f5;transition:color .2s}
#respec-menu{position:absolute;margin:0;padding:0;font-family:sans-serif;background:var(--bg,#fff);color:var(--text,#000);box-shadow:1px 1px 8px 0 rgba(100,100,100,.5);width:200px;display:none;text-align:left;margin-top:32px;font-size:.8em}
#respec-menu:not([hidden]){display:block}
#respec-menu li{list-style-type:none;margin:0;padding:0}
.respec-save-buttons{display:grid;grid-template-columns:repeat(auto-fill,minmax(47%,2fr));grid-gap:.5cm;padding:.5cm}
.respec-save-button:link{padding-top:16px;color:var(--def-text,#fff);background:var(--def-bg,#2a5aa8);justify-self:stretch;height:1cm;text-decoration:none;text-align:center;font-size:inherit;border:none;border-radius:.2cm}
.respec-save-button:link:hover{color:var(--def-text,#fff);background:var(--defrow-border,#2a5aa8);padding:0;margin:0;border:0;padding-top:16px}
.respec-save-button:link:focus{background:var(--tocnav-active-bg,#193766);color:var(--tocnav-active-text,#000)}
#respec-pill:focus,#respec-ui button:focus,.respec-option:focus{outline:0;outline-style:none}
#respec-pill-error{background-color:red;color:#fff}
#respec-pill-warning{background-color:orange;color:#fff}
.respec-error-list,.respec-warning-list{margin:0;padding:0;font-family:sans-serif;font-size:.85em}
.respec-warning-list{background-color:#fffbe6}
:is(.respec-warning-list,.respec-error-list)>li{list-style-type:none;margin:0;padding:.5em 0;padding-left:2em;padding-right:.5em}
:is(.respec-warning-list,.respec-error-list)>li+li{margin-top:.5rem}
:is(.respec-warning-list,.respec-error-list)>li:before{position:absolute;left:.4em}
:is(.respec-warning-list,.respec-error-list) p{padding:0;margin:0}
.respec-warning-list>li{color:#5c3b00;border-bottom:thin solid #fff5c2}
.respec-error-list,.respec-error-list li{background-color:#fff0f0}
.respec-warning-list>li::before{content:"‚ö†Ô∏è"}
.respec-error-list>li::before{content:"üí•"}
.respec-error-list>li{color:#5c3b00;border-bottom:thin solid #ffd7d7}
:is(.respec-warning-list,.respec-error-list)>li li{list-style:disc}
#respec-overlay{display:block;position:fixed;z-index:10000;top:0;left:0;height:100%;width:100%;background:#000}
.respec-show-overlay{transition:opacity .2s linear;opacity:.5}
.respec-hide-overlay{transition:opacity .2s linear;opacity:0}
.respec-modal{display:block;position:fixed;z-index:11000;top:10%;background:var(--bg,#fff);color:var(--text,#000);border:5px solid #666;border-color:var(--tocsidebar-shadow,#666);min-width:20%;padding:0;max-height:80%;overflow-y:auto;margin:0 -.5cm;left:20%;max-width:75%;min-width:60%}
.respec-modal h3{margin:0;padding:.2em;left:0!important;text-align:center;background:var(--tocsidebar-shadow,#ddd);color:var(--text,#000);font-size:1em}
#respec-menu button.respec-option{background:var(--bg,#fff);color:var(--text,#000);border:none;width:100%;text-align:left;font-size:inherit;padding:1.2em 1.2em}
#respec-menu button.respec-option:hover{background-color:var(--tocnav-hover-bg,#eee);color:var(--tocnav-hover-text,#000)}
.respec-cmd-icon{padding-right:.5em}
#respec-ui button.respec-option:first-child{margin-top:0}
#respec-ui button.respec-option:last-child{border:none;border-radius:inherit;margin-bottom:0}
.respec-button-copy-paste{position:absolute;height:28px;width:40px;cursor:pointer;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #90b8de;border-left:0;border-radius:0 0 3px 0;-webkit-user-select:none;user-select:none;-webkit-appearance:none;top:0;left:127px}
@media print{
#respec-ui{display:none}
}
.respec-iframe{width:100%;min-height:550px;height:100%;overflow:hidden;padding:0;margin:0;border:0}
.respec-iframe:not(.ready){background:url(https://respec.org/xref/loader.gif) no-repeat center}
.respec-iframe+a[href]{font-size:.9rem;float:right;margin:0 .5em .5em;border-bottom-width:1px}
p:is(.respec-hint,.respec-occurrences){display:block;margin-top:.5em}
.respec-plugin{text-align:right;color:rgb(120,120,120,.5);font-size:.6em}</style><style id="respec-mainstyle">@keyframes pop{
0%{transform:scale(1,1)}
25%{transform:scale(1.25,1.25);opacity:.75}
100%{transform:scale(1,1)}
}
a.internalDFN{color:inherit;border-bottom:1px solid #99c;text-decoration:none}
a.externalDFN{color:inherit;border-bottom:1px dotted #ccc;text-decoration:none}
a.bibref{text-decoration:none}
.respec-offending-element:target{animation:pop .25s ease-in-out 0s 1}
.respec-offending-element,a[href].respec-offending-element{text-decoration:red wavy underline}
@supports not (text-decoration:red wavy underline){
.respec-offending-element:not(pre){display:inline-block}
.respec-offending-element{background:url(data:image/gif;base64,R0lGODdhBAADAPEAANv///8AAP///wAAACwAAAAABAADAEACBZQjmIAFADs=) bottom repeat-x}
}
#references :target{background:#eaf3ff;animation:pop .4s ease-in-out 0s 1}
cite .bibref{font-style:normal}
a[href].orcid{padding-left:4px;padding-right:4px}
a[href].orcid>svg{margin-bottom:-2px}
ol.tof,ul.tof{list-style:none outside none}
.caption{margin-top:.5em;font-style:italic}
#issue-summary>ul{column-count:2}
#issue-summary li{list-style:none;display:inline-block}
details.respec-tests-details{margin-left:1em;display:inline-block;vertical-align:top}
details.respec-tests-details>*{padding-right:2em}
details.respec-tests-details[open]{z-index:999999;position:absolute;border:thin solid #cad3e2;border-radius:.3em;background-color:#fff;padding-bottom:.5em}
details.respec-tests-details[open]>summary{border-bottom:thin solid #cad3e2;padding-left:1em;margin-bottom:1em;line-height:2em}
details.respec-tests-details>ul{width:100%;margin-top:-.3em}
details.respec-tests-details>li{padding-left:1em}
.self-link:hover{opacity:1;text-decoration:none;background-color:transparent}
aside.example .marker>a.self-link{color:inherit}
.header-wrapper{display:flex;align-items:baseline}
:is(h2,h3,h4,h5,h6):not(#toc>h2,#abstract>h2,#sotd>h2,.head>h2){position:relative;left:-.5em}
:is(h2,h3,h4,h5,h6):not(#toch2)+a.self-link{color:inherit;order:-1;position:relative;left:-1.1em;font-size:1rem;opacity:.5}
:is(h2,h3,h4,h5,h6)+a.self-link::before{content:"¬ß";text-decoration:none;color:var(--heading-text)}
:is(h2,h3)+a.self-link{top:-.2em}
:is(h4,h5,h6)+a.self-link::before{color:#000}
@media (max-width:767px){
dd{margin-left:0}
}
@media print{
.removeOnSave{display:none}
}</style><link rel="dns-prefetch" crossorigin="anonymous" href="https://api.specref.org/" class="removeOnSave"><link rel="preconnect" crossorigin="anonymous" href="https://respec.org/" class="removeOnSave"><link rel="preload" as="script" href="https://www.w3.org/Tools/respec/respec-highlight" class="removeOnSave"><script src="ActivityPub%20and%20HTTP%20Signatures_files/prompt.js"></script><link rel="stylesheet" href="ActivityPub%20and%20HTTP%20Signatures_files/cg-draft.css"><meta name="description" content="Authentication is not specified by the ActivityPub standard. In practice, the fediverse mostly uses HTTP Message Signatures to authenticate server-to-server requests, using a relatively consistent profile. This document describes that profile and usage, recommends best practices, and evaluates their success so far."><style class="removeOnSave">var:hover{text-decoration:underline;cursor:pointer}
var.respec-hl{color:var(--color,#000);background-color:var(--bg-color);box-shadow:0 0 0 2px var(--bg-color)}
@media (prefers-color-scheme:dark){
var.respec-hl{filter:saturate(.9) brightness(.9)}
}
var.respec-hl-c1{--bg-color:#f4d200}
var.respec-hl-c2{--bg-color:#ff87a2}
var.respec-hl-c3{--bg-color:#96e885}
var.respec-hl-c4{--bg-color:#3eeed2}
var.respec-hl-c5{--bg-color:#eacfb6}
var.respec-hl-c6{--bg-color:#82ddff}
var.respec-hl-c7{--bg-color:#ffbcf2}
@media print{
var.respec-hl{background:0 0;color:#000;box-shadow:unset}
}</style><style>var{position:relative;cursor:pointer}
var[data-type]::after,var[data-type]::before{position:absolute;left:50%;top:-6px;opacity:0;transition:opacity .4s;pointer-events:none}
var[data-type]::before{content:"";transform:translateX(-50%);border-width:4px 6px 0 6px;border-style:solid;border-color:transparent;border-top-color:#222}
var[data-type]::after{content:attr(data-type);transform:translateX(-50%) translateY(-100%);background:#222;text-align:center;font-family:"Dank Mono","Fira Code",monospace;font-style:normal;padding:6px;border-radius:3px;color:#daca88;text-indent:0;font-weight:400}
var[data-type]:hover::after,var[data-type]:hover::before{opacity:1}</style><meta name="monetization" content="$respec.org" class="removeOnSave"><script id="initialUserConfig" type="application/json">{
  "specStatus": "CG-DRAFT",
  "editors": [
    {
      "name": "Ryan Barrett",
      "url": "https://snarfed.org/"
    },
    {
      "name": "nightpool",
      "url": "https://github.com/nightpool"
    }
  ],
  "github": "swicg/activitypub-http-signature",
  "shortName": "apsig",
  "xref": "web-platform",
  "group": "socialcg",
  "publishISODate": "2024-04-16T00:00:00.000Z",
  "generatedSubtitle": "Draft Community Group Report 16 April 2024"
}</script>
<script src="annost.js" async></script>
</head>
  <body class="h-entry informative toc-sidebar" data-cite="HTML INFRA URL WEBIDL DOM FETCH"><p id="toc-nav"><a id="toc-jump" href="#toc"><span aria-hidden="true">‚Üë</span> <span>Jump to Table of Contents</span></a><a id="toc-toggle" href="#toc"><span aria-hidden="true">‚Üê</span> <span>Collapse Sidebar</span></a></p><div id="respec-ui" class="removeOnSave"><button id="respec-pill" aria-controls="respec-menu" aria-expanded="false" aria-haspopup="true" aria-label="ReSpec Menu">ReSpec</button><ul id="respec-menu" role="menu" aria-labelledby="respec-pill" hidden=""><li role="menuitem"><button class="respec-option" id="respec-button-search-specref">
      <span class="respec-cmd-icon" aria-hidden="true">üîé<!---0.024474%--></span> Search Specref<!---0.024474%-->‚Ä¶
    </button><!---0.024474%--></li><li role="menuitem"><button class="respec-option" id="respec-button-search-definitions">
      <span class="respec-cmd-icon" aria-hidden="true">üìö<!---0.024474%--></span> Search definitions<!---0.024474%-->‚Ä¶
    </button><!---0.024474%--></li><li role="menuitem"><button class="respec-option" id="respec-button-about-35.0.0">
      <span class="respec-cmd-icon" aria-hidden="true">‚ÑπÔ∏è<!---0.024474%--></span> About 35.0.0<!---0.024474%-->‚Ä¶
    </button><!---0.024474%--></li><li role="menuitem"><button class="respec-option" id="respec-button-export">
      <span class="respec-cmd-icon" aria-hidden="true">üíæ<!---0.024474%--></span> Export<!---0.024474%-->‚Ä¶
    </button><!---0.024474%--></li></ul></div><div class="head">
    <!---0.024474%-->
    <h1 id="title" class="title">ActivityPub and HTTP Signatures</h1><!---0.024474%--> <!---0.024474%-->
    <p id="w3c-state">
      <a href="https://www.w3.org/standards/types#reports">Draft Community Group Report<!---0.024474%--></a>
      <time class="dt-published" datetime="2024-04-16">16 April 2024<!---0.024474%--></time>
    </p>
    <dl>
      <!---0.024474%-->
      <dt>Latest published version:<!---0.024474%--></dt><dd>
              <a href="https://www.w3.org/apsig/">https://www.w3.org/apsig/<!---0.024474%--></a><!---0.024474%-->
            </dd><!---0.024474%-->
      <dt>Latest editor's draft:<!---0.024474%--></dt><dd><a href="https://swicg.github.io/activitypub-http-signature/">https://swicg.github.io/activitypub-http-signature/<!---0.024474%--></a></dd><!---0.024474%-->
      <!---0.024474%-->
      <!---0.024474%-->
      <!---0.024474%-->
      <!---0.024474%--><!---0.024474%-->
      <dt>Editors:<!---0.024474%--></dt><dd class="editor p-author h-card vcard">
    <a class="u-url url p-name fn" href="https://snarfed.org/">Ryan Barrett<!---0.024474%--></a><!---0.024474%-->
  </dd><dd class="editor p-author h-card vcard">
    <a class="u-url url p-name fn" href="https://github.com/nightpool">nightpool<!---0.024474%--></a><!---0.024474%-->
  </dd><!---0.024474%--><!---0.024474%-->
      <!---0.024474%-->
      <!---0.024474%-->
      <dt>Feedback:<!---0.024474%--></dt><dd>
        <a href="https://github.com/swicg/activitypub-http-signature/">GitHub swicg/activitypub-http-signature<!---0.024474%--></a>
        (<a href="https://github.com/swicg/activitypub-http-signature/pulls/">pull requests</a>,
        <a href="https://github.com/swicg/activitypub-http-signature/issues/new/choose">new issue</a>,
        <a href="https://github.com/swicg/activitypub-http-signature/issues/">open issues</a>)
      </dd><!---0.024474%--><!---0.024474%-->
      <!---0.024474%-->
    </dl>
    <!---0.024474%-->
    <p class="copyright">
          <a href="https://www.w3.org/policies/#copyright">Copyright</a>
          ¬©
          <!---0.024474%-->2024<!---0.024474%-->
          <!---0.024474%-->
          the Contributors to the ActivityPub and HTTP Signatures<!---0.024474%-->
          Specification, published by the
          <a href="https://www.w3.org/groups/cg/socialcg">Social Web Incubator Community Group<!---0.024474%--></a> under the
          <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>. A human-readable
                <a href="https://www.w3.org/community/about/agreements/cla-deed/">summary</a>
                is available.
              <!---0.024474%-->
        </p><!---0.024474%-->
    <hr title="Separator for header">
  </div>
    <br>
    <p><em>This document is non-normative.</em></p>

<annost-note>
  <h1 id='annost-title'>
    Annotated by <a href="https://github.com/jernst/annost/">AnnoST</a>.
  </h1>
  <p>We use the same roles definitions as given in <a href="../../activitypub/TEST-SOURCES/index-annost.html">AnnoST'd ActivityPub</a> standard.</p>
</annost-note>
    <section id="abstract" class="introductory"><!--OddPage--><h2>Abstract<!---0.024474%--></h2>
      <p>Authentication is not specified by the <cite><a data-cite="ActivityPub" data-matched-text="[[[ActivityPub]]]" href="https://www.w3.org/TR/activitypub/">ActivityPub</a></cite> standard. In practice, the fediverse mostly uses <cite><a data-cite="RFC9421" data-matched-text="[[[RFC9421]]]" href="https://www.rfc-editor.org/rfc/rfc9421">HTTP Message Signatures</a></cite>
 to authenticate server-to-server requests, using a relatively
consistent profile. This document describes that profile and usage,
recommends best practices, and evaluates their success so far.</p>
    </section>

    <section id="sotd" class="introductory"><!--OddPage--><h2>Status of This Document<!---0.024474%--></h2><!---0.024474%--><p>
      This specification was published by the
      <a href="https://www.w3.org/groups/cg/socialcg">Social Web Incubator Community Group<!---0.024474%--></a>. It is not a W3C Standard nor is it
      on the W3C Standards Track.

            Please note that under the
            <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>
            there is a limited opt-out and other conditions apply.
          <!---0.024474%-->
      Learn more about
      <a href="https://www.w3.org/community/">W3C Community and Business Groups</a>.
    </p>
    <!---0.024474%--><!---0.024474%--><p>
    <a href="https://github.com/swicg/activitypub-http-signature/issues/">GitHub Issues</a> are preferred for
          discussion of this specification.
        <!---0.024474%-->
    <!---0.024474%-->
  </p><!---0.024474%--><!---0.024474%--><!---0.024474%--><!---0.024474%--></section><nav id="toc"><h2 class="introductory" id="table-of-contents">Table of Contents<!---0.024474%--></h2><ol class="toc"><li class="tocline"><a class="tocxref" href="#abstract">Abstract<!---0.024474%--></a><!---0.024474%--></li><li class="tocline"><a class="tocxref" href="#sotd">Status of This Document<!---0.024474%--></a><!---0.024474%--></li><li class="tocline"><a class="tocxref" href="#introduction"><bdi class="secno">1.<!---0.024474%--> </bdi>Introduction</a><!---0.024474%--><ol class="toc"><li class="tocline"><a class="tocxref" href="#non-goals"><bdi class="secno">1.1<!---0.024474%--> </bdi>Non-goals</a><!---0.024474%--></li><li class="tocline"><a class="tocxref" href="#comparison-with-other-networks"><bdi class="secno">1.2<!---0.024474%--> </bdi>Comparison with other networks</a><!---0.024474%--></li><li class="tocline"><a class="tocxref" href="#survey-of-standards-compliance"><bdi class="secno">1.3<!---0.024474%--> </bdi>Survey of standards compliance</a><!---0.024474%--></li><li class="tocline"><a class="tocxref" href="#related-work"><bdi class="secno">1.4<!---0.024474%--> </bdi>Related work</a><!---0.024474%--></li></ol></li><li class="tocline"><a class="tocxref" href="#basic-usage"><bdi class="secno">2.<!---0.024474%--> </bdi>Basic usage</a><!---0.024474%--><ol class="toc"><li class="tocline"><a class="tocxref" href="#how-to-sign-a-request"><bdi class="secno">2.1<!---0.024474%--> </bdi>How to sign a request</a><!---0.024474%--></li><li class="tocline"><a class="tocxref" href="#how-to-verify-a-signature"><bdi class="secno">2.2<!---0.024474%--> </bdi>How to verify a signature</a><!---0.024474%--></li><li class="tocline"><a class="tocxref" href="#how-to-obtain-a-signature-s-public-key"><bdi class="secno">2.3<!---0.024474%--> </bdi>How to obtain a signature's public key</a><!---0.024474%--></li></ol></li><li class="tocline"><a class="tocxref" href="#additional-considerations"><bdi class="secno">3.<!---0.024474%--> </bdi>Additional considerations</a><!---0.024474%--><ol class="toc"><li class="tocline"><a class="tocxref" href="#authorized-fetch"><bdi class="secno">3.1<!---0.024474%--> </bdi>Authorized fetch</a><!---0.024474%--></li><li class="tocline"><a class="tocxref" href="#instance-actor"><bdi class="secno">3.2<!---0.024474%--> </bdi>Instance actor</a><!---0.024474%--></li><li class="tocline"><a class="tocxref" href="#handling-deletes-of-actors"><bdi class="secno">3.3<!---0.024474%--> </bdi>Handling <code>Delete</code>s of actors</a><!---0.024474%--></li><li class="tocline"><a class="tocxref" href="#compatibility-with-http-caching"><bdi class="secno">3.4<!---0.024474%--> </bdi>Compatibility with HTTP caching</a><!---0.024474%--></li><li class="tocline"><a class="tocxref" href="#how-to-upgrade-supported-versions"><bdi class="secno">3.5<!---0.024474%--> </bdi>How to upgrade supported versions</a><!---0.024474%--></li><li class="tocline"><a class="tocxref" href="#key-rotation"><bdi class="secno">3.6<!---0.024474%--> </bdi>Key rotation</a><!---0.024474%--></li></ol></li><li class="tocline"><a class="tocxref" href="#so-what-s-the-verdict"><bdi class="secno">4.<!---0.024474%--> </bdi>So, what's the verdict?</a><!---0.024474%--></li><li class="tocline"><a class="tocxref" href="#references"><bdi class="secno">A.<!---0.024474%--> </bdi>References<!---0.024474%--></a><!---0.024474%--><ol class="toc"><li class="tocline"><a class="tocxref" href="#informative-references"><bdi class="secno">A.1<!---0.024474%--> </bdi>Informative references<!---0.024474%--></a><!---0.024474%--></li></ol></li></ol></nav>

    <section id="introduction"><!--OddPage--><div class="header-wrapper"><h2 id="x1-introduction"><bdi class="secno">1.<!---0.024474%--> </bdi>Introduction</h2><a class="self-link" href="#introduction" aria-label="Permalink for Section 1."></a></div>

      <p>[<cite><a class="bibref" data-link-type="biblio" href="#bib-activitypub" title="ActivityPub">ActivityPub<!---0.024474%--></a></cite><!---0.024474%-->]
 lets people interact on the fediverse without an existing shared trust
anchor. That's great! They still need some form of trust model, though,
even if the protocol is decentralized. Specifically, they need to
authenticate actors who send activities and request objects, and they
need to check whether those actors are authorized to send those
activities and request those objects.</p>

<p><a href="https://www.w3.org/wiki/SocialCG/ActivityPub/Authentication_Authorization">The (non-normative) ActivityPub primer discusses authentication and authorization in detail</a>,
 but the standard itself leaves authentication and authorization largely
 unspecified. It implies that authorization is a "same origin model"
(not to be confused with web browsers): an actor can generally only
create, update, or delete objects with itself as actor or <code>attributedTo</code>. Some of this is deferred to <cite><a data-cite="activitystreams-core" data-matched-text="[[[activitystreams-core]]]" href="https://www.w3.org/TR/activitystreams-core/">Activity Streams 2.0</a></cite>.</p>

<p>For authentication, in practice, the fediverse currently uses a
custodial trust model. Each user has one or more asymmetric keypairs,
and their instance (server) is generally trusted to hold their private
keys, serve their public keys, generate signatures, and serve objects
and send activities on their behalf. Most servers require SSL for
server-to-server HTTP connections in order to authenticate server
domains.</p>

<p>ActivityPub suggests <cite><a data-cite="RFC9421" data-matched-text="[[[RFC9421]]]" href="https://www.rfc-editor.org/rfc/rfc9421">HTTP Message Signatures</a></cite> and <a href="https://web.archive.org/web/20170923124140/https://w3c-dvcg.github.io/ld-signatures/">Linked Data Signatures</a>
 as additional authentication mechanisms. ActivityPub inbox delivery
POSTs generally include an HTTP Signature from the sending actor, and
for inbox forwarding, sometimes also an LD Signature from the original
actor. Object and activity GETs often include an HTTP Signature from the
 requesting actor.</p>

<p>This document describes the fediverse's current usage of HTTP
Signatures for ActivityPub server-to-server requests, recommends best
practices, and evaluates their success so far.

    </p><section id="non-goals"><div class="header-wrapper"><h3 id="x1-1-non-goals"><bdi class="secno">1.1<!---0.024474%--> </bdi>Non-goals</h3><a class="self-link" href="#non-goals" aria-label="Permalink for Section 1.1"></a></div>

<p>Those are broad goals, and this report is limited in scope. Here are a
 number of non-goals that are intentionally not addressed or prioritized
 here.</p>
<ul>
<li> Authorization or access control. We mention them here and there, but we don't try to cover them comprehensively.</li>
<li> Reproducing the contents of existing standards like HTTP Signatures itself (any version), PEM/PKCS, SHA-256, <cite><a data-cite="activitystreams-core" data-matched-text="[[[activitystreams-core]]]" href="https://www.w3.org/TR/activitystreams-core/">Activity Streams 2.0</a></cite>, <cite><a data-cite="vc-data-integrity" data-matched-text="[[[vc-data-integrity]]]" href="https://www.w3.org/TR/vc-data-integrity/">Verifiable Credential Data Integrity 1.0</a></cite>, HTTP headers, hash algorithms or cipher suites or cryptosystems, etc.</li>
<li> Strict standards compliance at the expense of interoperability.</li>
<li> Providing the strongest security possible, at the expense of interoperability.</li>
<li> Security analysis of HTTP Signatures, ActivityPub, their integration, or any individual implementation.</li>
<li> Nomadic identity.</li>
<li> Fragment handling in ActivityPub or ActivityStreams ids, beyond the minimum needed to resolve <code>keyId</code>s.</li>
<li> ActivityPub client to server, or generating signatures client side.</li>
</ul>

<p>We also don't expect to update this report on an ongoing basis. It describes a single snapshot in time, when it was published.</p>
    </section>

    <section id="comparison-with-other-networks"><div class="header-wrapper"><h3 id="x1-2-comparison-with-other-networks"><bdi class="secno">1.2<!---0.024474%--> </bdi>Comparison with other networks</h3><a class="self-link" href="#comparison-with-other-networks" aria-label="Permalink for Section 1.2"></a></div>


<p>Other decentralized social protocols have similar trust models and
authentication techniques. Almost are all some combination of SSL and/or
 per-user asymmetric keypairs. Here are a few examples.</p>
<ul>
<li>The <a href="https://indieweb.org/">IndieWeb</a> ecosystem uses
primarily SSL for authentication. Data is always fetched via HTTP GETs,
and each user is generally expected to have their own [sub]domain. It
also uses [<cite><a class="bibref" data-link-type="biblio" href="#bib-indieauth" title="IndieAuth">IndieAuth<!---0.024474%--></a></cite><!---0.024474%-->], a domain-based OAuth [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc6749" title="The OAuth 2.0 Authorization Framework">RFC6749<!---0.024474%--></a></cite><!---0.024474%-->] profile, to authenticate users with their own servers, but not for requests between servers themselves.</li>
<li><a href="https://atproto.com/">AT Protocol</a> <a href="https://atproto.com/specs/did">uses DIDs as user identities</a>, specifically <a href="https://github.com/did-method-plc/did-method-plc">did:plc</a> and <a href="https://w3c-ccg.github.io/did-method-web/">did:web</a>. Each user has <a href="https://atproto.com/guides/overview#account-portability">two asymmetric keypairs, a signing key and a recovery key</a>.
 User data records are signed with one of these keys, usually the
signing key, and other services in the network verify those signatures.</li>
<li><a href="https://nostr.com/">Nostr</a> users publish an asymmetric keypair inside their <a href="https://github.com/nostr-protocol/nips/blob/master/01.md">NIP-01</a> user profile event to one or more relays. They sign all other events they publish with their private key.</li>
</ul>
    </section>

    <section id="survey-of-standards-compliance"><div class="header-wrapper"><h3 id="x1-3-survey-of-standards-compliance"><bdi class="secno">1.3<!---0.024474%--> </bdi>Survey of standards compliance</h3><a class="self-link" href="#survey-of-standards-compliance" aria-label="Permalink for Section 1.3"></a></div>


<p><a href="https://vpzom.click/">vpzom</a>'s <a href="https://arewehs2019yet.vpzom.click/">Are We HS2019 Yet?</a>
 web site faithfully tracks HTTP Signature support in popular fediverse
server projects over time. As of 2024-03-16, it covers 14 projects,
including 8 of the top 10 projects by total registered users.</p>
<p>We also confirmed micro.blog's and the WordPress ActivityPub plugin's
 HTTP Signature support. Combined with vpzom's survey, these 16 projects
 together cover 96% of registered users, 95% of MAUs, and 83% of
instances in the fediverse. (Based on <a href="https://fedidb.org/software">fedidb.org/software</a> and <a href="https://fedidb.org/software">fediverse.observer/stats</a>.)</p>
<p>We've refrained from duplicating vpzom's full contents, but here are a few highlights.</p>
<ul>
<li>
<p>All 16 projects support HTTP Signatures, both generating and sending
them in outbound requests and validating signatures on incoming
requests.</p>
</li>
<li>
<p>Based on this data and more, <cite><a data-cite="http-signatures" data-matched-text="[[[http-signatures]]]" href="https://datatracker.ietf.org/doc/html/draft-cavage-http-signatures">HTTP Signatures</a></cite> aka <em>cavage-12</em>
 is still the most commonly supported version in the fediverse by far.
Not many projects support later versions, especially not projects with
large user or instance bases.</p>
</li>
<li>
<p>Very few projects share implementation code. PeerTube and Misskey both use <a href="https://www.npmjs.com/package/@peertube/http-signature">@peertube/http-signature</a>, Pleroma and Mobilizon both use <a href="https://git.pleroma.social/pleroma/elixir-libraries/http_signatures">pleroma/http_signatures</a>, the rest all use their own implementations.</p>
</li>
<li>
<p>All projects except one support the <code>hs2019</code> placeholder
algorithm in at least some form. This is a good sign that the fediverse
is gradually advancing the version(s) of HTTP Signatures it supports,
but getting past cavage-12 will take more effort.</p>
</li>
</ul>
    </section>

    <section id="related-work"><div class="header-wrapper"><h3 id="x1-4-related-work"><bdi class="secno">1.4<!---0.024474%--> </bdi>Related work</h3><a class="self-link" href="#related-work" aria-label="Permalink for Section 1.4"></a></div>


<p><a href="https://codeberg.org/aumetra/fep/src/branch/fep-e2ce/fep/e2ce/fep-e2ce.md">FEP-e2ce</a> describes a similar standardized profile for HTTP Signatures in ActivityPub and the fediverse. <a href="https://github.com/swicg/activitypub-http-signature/issues/19">Its authors supported us in writing this report</a>, which we appreciate greatly!</p>
<p><a href="https://codeberg.org/fediverse/fep/src/branch/main/fep/521a/fep-521a.md">FEP-521a</a> describes an alternative way to support multiple keys per actor with <code>Multikey</code>.</p>
<p><a href="https://codeberg.org/fediverse/fep/src/branch/main/fep/ae97/fep-ae97.md">FEP-ae97</a> proposes a way for clients to hold users' keys and attach data integrity proof style signatures to activities.</p>

    </section>

    </section>

    <section id="basic-usage"><!--OddPage--><div class="header-wrapper"><h2 id="x2-basic-usage"><bdi class="secno">2.<!---0.024474%--> </bdi>Basic usage</h2><a class="self-link" href="#basic-usage" aria-label="Permalink for Section 2."></a></div>


    <section id="how-to-sign-a-request"><div class="header-wrapper"><h3 id="x2-1-how-to-sign-a-request"><bdi class="secno">2.1<!---0.024474%--> </bdi>How to sign a request</h3><a class="self-link" href="#how-to-sign-a-request" aria-label="Permalink for Section 2.1"></a></div>


<p>Here's how to sign an ActivityPub server-to-server HTTP request with a <a href="https://datatracker.ietf.org/doc/html/draft-cavage-http-signatures">cavage-12</a> HTTP Signature:</p>
<ol>
<li>Load the signing actor's private key.
<ol>
<li>If this is a new actor, generate and store a 2048-bit or larger <a href="https://en.wikipedia.org/wiki/RSA_(cryptosystem)">RSA keypair</a>.
 (Ed25519 is more modern, but not yet widely supported in the
fediverse.) Use an existing, mature, widely used cryptography library.</li>
</ol>
</li>
<li>Generate a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Digest"><code>Digest</code></a> [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc3230" title="Instance Digests in HTTP">RFC3230<!---0.024474%--></a></cite><!---0.024474%-->] header value. (Most servers should generally only require this for POST requests, so you may be able to omit it for GETs.)
<ol>
<li>Generate the <a href="https://en.wikipedia.org/wiki/SHA-2">SHA-256 hash</a> of the request body.</li>
<li>Base64-encode that hash.</li>
<li>Prefix the base64-encoded hash with the string <code>SHA-256=</code>.</li>
</ol>
</li>
<li>Generate the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Date"><code>Date</code></a>, <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Host"><code>Host</code></a>, and <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type"><code>Content-Type</code></a> header values.</li>
<li>Use the HTTP request's target URL as the <code>(request-target)</code> pseudo-header.</li>
<li>Follow <a href="https://datatracker.ietf.org/doc/html/draft-cavage-http-signatures#autoid-13">cavage-12 sections 2.3 and 2.4</a> to generate the signature with those five headers and values and the request body, if any.
<ol>
<li>Use <a href="https://datatracker.ietf.org/doc/html/draft-cavage-http-signatures#autoid-38"><code>hs2019</code></a> as the algorithm. This is a generic placeholder string that defers algorithm detection to the <code>keyId</code> public key's metadata.</li>
<li>Make sure that all header names are lower case. Details in cavage-12 section 2.3.</li>
</ol>
</li>
<li>Add the resulting signature string to the request in the <code>Signature</code> header <a href="https://datatracker.ietf.org/doc/html/draft-cavage-http-signatures#autoid-21">as described in cavage-12 section 4</a>.</li>
</ol>
<annost-test testid="2.1/1" name="Client signs request correctly" role="S2S-C-endpoint">
</annost-test>
    </section>

    <section id="how-to-verify-a-signature"><div class="header-wrapper"><h3 id="x2-2-how-to-verify-a-signature"><bdi class="secno">2.2<!---0.024474%--> </bdi>How to verify a signature</h3><a class="self-link" href="#how-to-verify-a-signature" aria-label="Permalink for Section 2.2"></a></div>


<p>Here's how to verify an incoming request's HTTP Signature, as described in <a href="https://datatracker.ietf.org/doc/html/draft-cavage-http-signatures-12#autoid-15">cavage-12 section 2.5</a>.
 If the verification fails, and you require a valid signature for the
given request, you should return an HTTP 401 error response.</p>
<ol>
<li>The HTTP Signature string is the value of the HTTP request's <code>Signature</code> header. If that header is not present, the request has no signature.</li>
<li>Extract the <a href="https://datatracker.ietf.org/doc/html/draft-cavage-http-signatures-12#autoid-6"><code>keyId</code> parameter</a> from the HTTP Signature.</li>
<li>Follow the instructions in <a href="#how-to-obtain-a-signature-s-public-key" data-matched-text="[[[#how-to-obtain-a-signature-s-public-key]]]" class="sec-ref"><bdi class="secno">2.3 </bdi>How to obtain a signature's public key</a> to obtain the public key for that <code>keyId</code>.</li>
<li>Extract the encryption algorithm from the signature. If it's <code>hs2019</code>, assume that means <code>rsa-sha256</code>, as described in <a href="#survey-of-standards-compliance" data-matched-text="[[[#survey-of-standards-compliance]]]" class="sec-ref"><bdi class="secno">1.3 </bdi>Survey of standards compliance</a>.
</li><li>Extract the signed headers from the signature. They should ideally include <code>Date</code>, <code>Host</code>, and <code>Content-Type</code>. They may also include <code>Digest</code> and the <code>(request-target)</code> pseudo-header with the target URL.</li>
<li>Generate the expected request body digest:
<ol>
<li>Generate the <a href="https://en.wikipedia.org/wiki/SHA-2">SHA-256 hash</a> of the request body.</li>
<li>Base64-encode that hash.</li>
<li>Prefix the base64-encoded hash with the string <code>SHA-256=</code>.</li>
</ol>
</li>
<li>Optionally compare this to the request's <code>Digest</code> header.
 If they don't match, the signature is invalid, and you can optionally
return an informative message in the error response.</li>
<li>Compare the request's <code>Date</code> header to the current time.
If they differ significantly, the verification fails. (The standards
don't give a concrete time window to use for this comparison. In
practice, an hour plus a few minutes buffer in either direction may be a
 good value, to account for both clock skew and differences in time
zone/daylight savings time configuration across systems.)</li>
<li>Follow <a href="https://datatracker.ietf.org/doc/html/draft-cavage-http-signatures-12#autoid-15">cavage-12 section 2.5</a> to check the signature in the <code>Signature</code> header.</li>
<li>If that verification fails, and you're using a locally cached public key, the actor may have rotated their key (see <a href="#key-rotation" data-matched-text="[[[#key-rotation]]]" class="sec-ref"><bdi class="secno">3.6 </bdi>Key rotation</a>). Go back to step 3, re-fetch the actor and key from their source, and try again.</li>
</ol>
<annost-test testid="2.2/1" name="Server does not serve invalidly signed requests" role="S2S-S-endpoint">
</annost-test>
    </section>

    <section id="how-to-obtain-a-signature-s-public-key"><div class="header-wrapper"><h3 id="x2-3-how-to-obtain-a-signature-s-public-key"><bdi class="secno">2.3<!---0.024474%--> </bdi>How to obtain a signature's public key</h3><a class="self-link" href="#how-to-obtain-a-signature-s-public-key" aria-label="Permalink for Section 2.3"></a></div>


<p>Here's how to find the public key to use to verify a fediverse HTTP Signature:</p>
<ol>
<li>Extract the signature's <a href="https://datatracker.ietf.org/doc/html/draft-cavage-http-signatures-12#section-2.1.1"><code>keyId</code> parameter</a>. It should be a URL. If it has a fragment, discard it.</li>
<li>If you cache remote ActivityPub objects locally, look up the object with that id in your local store.</li>
<li>If you don't have it locally, fetch it. (If it's an <a href="#instance-actor" data-matched-text="[[[#instance-actor]]]" class="sec-ref"><bdi class="secno">3.2 </bdi>Instance actor</a>, the remote server generally won't expect or try to verify any signature on your own fetch request.)</li>
<li>If it's an <cite><a data-cite="activitystreams-core" data-matched-text="[[[activitystreams-core]]]" href="https://www.w3.org/TR/activitystreams-core/">Activity Streams 2.0</a></cite> <a href="https://www.w3.org/TR/activitystreams-core/#actors">actor</a>, continue to step 7.</li>
<li>If it's a raw <a href="https://w3c-ccg.github.io/security-vocab/#Key"><code>Key</code> object</a>, use its <code>controller</code> or <code>owner</code>
 property as the new key id, jump back to step 2, and repeat. (This is
necessary to confirm that the owner actually owns and uses this key.)</li>
<li>Otherwise, the key can't be fetched at this time, and the signature verification fails.</li>
<li>The public key object will be in the actor's <code>publicKey</code> property. If there are multiple values, find the one whose <code>id</code> matches the original <code>keyId</code>.</li>
<li>The <a href="https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail">PEM-encoded</a> public key will be in the key object's <code>publicKeyPem</code> property. This is based on <a href="https://w3c-ccg.github.io/security-vocab/#publicKey">LD Security Vocabulary v1</a>. Use your cryptography library to decode it as a PEM public key. (It may be encoded as <a href="https://datatracker.ietf.org/doc/html/rfc3447">PKCS-1</a>, <a href="https://datatracker.ietf.org/doc/html/rfc5280#appendix-A">X.509 SPKI</a>, or something else; your library should detect its format automatically.)</li>
</ol>
<p>Note that a <a href="https://w3c.github.io/vc-data-integrity/vocab/security/vocabulary.html">newer version of the LD Security Vocabulary</a> (part of <a href="https://w3c.github.io/vc-data-integrity/">Verifiable Credential Data Integrity</a>) removes the <code>publicKey</code> property. <a href="https://codeberg.org/fediverse/fep/src/branch/main/fep/521a/fep-521a.md">FEP-521a</a> is an alternative that supports key objects anywhere in actors, eg in the <code>assertionMethod</code> property, but it's not yet widely supported in the fediverse.</p>
<annost-test testid="2.3/1" name="Client retrieves public key correctly" role="S2S-C-endpoint">
</annost-test>
<annost-test testid="2.3/2" name="Server publishes public key correctly" role="S2S-S-endpoint">
</annost-test>
    </section>

    </section>

    <section id="additional-considerations"><!--OddPage--><div class="header-wrapper"><h2 id="x3-additional-considerations"><bdi class="secno">3.<!---0.024474%--> </bdi>Additional considerations</h2><a class="self-link" href="#additional-considerations" aria-label="Permalink for Section 3."></a></div>


    <section id="authorized-fetch"><div class="header-wrapper"><h3 id="x3-1-authorized-fetch"><bdi class="secno">3.1<!---0.024474%--> </bdi>Authorized fetch</h3><a class="self-link" href="#authorized-fetch" aria-label="Permalink for Section 3.1"></a></div>


<p>Some servers have a feature called <em>authorized fetch</em>, aka
secure mode, which requires HTTP Signatures on all HTTP GET requests for
 objects and activities. This is intended to increase the server's
control over who can access its data. <a href="https://docs.joinmastodon.org/admin/config/#authorized_fetch">From Mastodon's documentation</a>:</p>
<blockquote>As a result, through the authentication mechanism and
avoiding re-distribution mechanisms that do not have your server in the
loop, it becomes possible to enforce who can and cannot retrieve even
public content from your server, e.g. servers whose domains you have
blocked.</blockquote>
<p>For public posts and data, servers with authorized fetch enabled
generally don't enforce any fine grained access control over the actors
whose signatures they require. They usually only reject requests from
actors on domains that they've blocked at the server level. (This means
that the name authorized fetch is maybe partially a misnomer, and
something like signed fetch might be more appropriate.)</p>
<p>For non-public data, eg followers-only or mention-only posts aka
direct messages, servers generally do check that GET requests are signed
 by actors who should have access to that data.</p>
<annost-test testid="3.1/1" name="Reject requests from actors that have been blocked by their domain name">
</annost-test>
<annost-test testid="3.1/2" name="Reject requests from actors that have been blocked by their handle">
</annost-test>
     </section>
     <section id="instance-actor"><div class="header-wrapper"><h3 id="x3-2-instance-actor"><bdi class="secno">3.2<!---0.024474%--> </bdi>Instance actor</h3><a class="self-link" href="#instance-actor" aria-label="Permalink for Section 3.2"></a></div>


<p>One consequence of <a href="#authorized-fetch" data-matched-text="[[[#authorized-fetch]]]" class="sec-ref"><bdi class="secno">3.1 </bdi>Authorized fetch</a> is that signed fetches can end up in a kind of deadlock or infinite loop. If server a.example fetches <a href="https://b.example/bob">https://b.example/bob</a> with <a href="https://a.example/alice">https://a.example/alice</a>'s signature, and b.example doesn't have alice's public key, it will get it by fetching <a href="https://a.example/alice">https://a.example/alice</a> with <a href="https://b.example/bob's">https://b.example/bob's</a> signature. a.example won't have bob's public key either, so it will again try to fetch <a href="https://b.example/bob">https://b.example/bob</a>, and the cycle will continue.</p>
<p>To prevent this, servers with authorized fetch enabled often use an <a href="https://seb.jambor.dev/posts/understanding-activitypub-part-4-threads/#the-instance-actor">instance actor</a>
 to sign object fetches. This is generally a "server-level" actor,
separate from any normal user, that doesn't require an HTTP Signature to
 be fetched. This breaks the loop of fetching each actor back and forth
to validate their signatures.</p>
<annost-test testid="3.2/1" name="Instance actor document fetch does not require HTTP signature">
</annost-test>
<annost-test testid="3.2/2" name="Actor document of any actor on a server can be fetched with a signature of the instance actor">
</annost-test>
<annost-note>
Is it possible for a receiver of a signed request to determine whether the request was signed by an instance actor
or by some other actor on the same server? Are they distinguishable? If they are not, does that mean that Any
actor on a server b.example can obtain the actor document of any actor on a.example?
</annost-note>
    </section>

    <section id="handling-deletes-of-actors"><div class="header-wrapper"><h3 id="x3-3-handling-deletes-of-actors"><bdi class="secno">3.3<!---0.024474%--> </bdi>Handling <code>Delete</code>s of actors</h3><a class="self-link" href="#handling-deletes-of-actors" aria-label="Permalink for Section 3.3"></a></div>


<p><code>Delete</code> activities that delete actors can have extra
complications. The actor object may already be deleted on the source
server, so fetching it might return a 410 or 404 error. Or, the <code>Delete</code> activity may be signed by the remote server's <a href="#instance-actor" data-matched-text="[[[#instance-actor]]]" class="sec-ref"><bdi class="secno">3.2 </bdi>Instance actor</a> instead of the actor itself.</p>
<p>Here's a process for handling <code>Delete</code> activities that delete actors:</p>
<ol>
<li>Attempt to verify the request's signature by following <a href="#how-to-verify-a-signature" data-matched-text="[[[#how-to-verify-a-signature]]]" class="sec-ref"><bdi class="secno">2.2 </bdi>How to verify a signature</a>. If that succeeds, process the <code>Delete</code>.</li>
<li>If the signature's <code>keyId<!---0.024474%--></code> doesn't match the <code>Delete</code>'s <code>object</code> or its server's <a href="#instance-actor" data-matched-text="[[[#instance-actor]]]" class="sec-ref"><bdi class="secno">3.2 </bdi>Instance actor</a>, discard the <code>Delete</code> and do not process it.<br>
<em>Note that there is no standard process for identifying a given
server's instance actor! If in doubt, do not process the activity.</em></li>
<li>If fetching the <code>keyId<!---0.024474%--></code> in <a href="#how-to-obtain-a-signature-s-public-key" data-matched-text="[[[#how-to-obtain-a-signature-s-public-key]]]" class="sec-ref"><bdi class="secno">2.3 </bdi>How to obtain a signature's public key</a> fails with an HTTP 410 error, that means the actor has been deleted. Process the Delete.</li>
<li>If fetching the <code>keyId<!---0.024474%--></code> in <a href="#how-to-obtain-a-signature-s-public-key" data-matched-text="[[[#how-to-obtain-a-signature-s-public-key]]]" class="sec-ref"><bdi class="secno">2.3 </bdi>How to obtain a signature's public key</a> fails with an HTTP 404 error, the actor <em>may</em> have been deleted, or something else may have happened. Do not process the <code>Delete</code>.</li>
</ol>

<annost-test testid="3.3/1" name="Test that actor deletes signed by the actor's own key are being processed">
</annost-test>
<annost-note>
Given we can't identify instance actors, we cannot test whether they can, too, because we don't want non-instance actors
to be able to delete on accounts other than their own.
</annost-note>
    </section>

    <section id="compatibility-with-http-caching"><div class="header-wrapper"><h3 id="x3-4-compatibility-with-http-caching"><bdi class="secno">3.4<!---0.024474%--> </bdi>Compatibility with HTTP caching</h3><a class="self-link" href="#compatibility-with-http-caching" aria-label="Permalink for Section 3.4"></a></div>


<p>HTTP responses are cached in a wide variety of ways across the web.
HTTP Signatures in ActivityPub requests can affect the resulting
responses, so clients and servers both need to take signatures account
when interacting with caches.</p>
<p>The main thing ActivityPub servers need to do is include <code>Signature</code> in their <code>Vary</code> header for responses that depend on request signatures, eg if they require <a href="#authorized-fetch" data-matched-text="[[[#authorized-fetch]]]" class="sec-ref"><bdi class="secno">3.1 </bdi>Authorized fetch</a>
 and would return a 4xx error if a signature is missing or invalid. This
 prevents valid responses from being cached and returned to other future
 requests with missing or invalid signatures.</p>
<p>(This is similar to including <code>Content-Type</code> in the <code>Vary</code> response header for URLs that can return either user-facing HTML or <cite><a data-cite="activitystreams-core" data-matched-text="[[[activitystreams-core]]]" href="https://www.w3.org/TR/activitystreams-core/">Activity Streams 2.0</a></cite> JSON, depending on content negotiation.)</p>
<p>One downside of this is that ActivityPub objects from servers that
require authorized fetch generally can't be cached. HTTP Signatures
include timestamps via the <code>Date</code> header, and are often
generated by different private keys, so they'll almost never be the same
 across requests. This is an unfortunate side effect, but necessary for
servers that want to control access based on the requester's identity.</p>
<annost-test testid="3.4/1" name="Servers set the required Vary header for URIs that may return different content based on requested Content-Type">
</annost-test>
    </section>

    <section id="how-to-upgrade-supported-versions"><div class="header-wrapper"><h3 id="x3-5-how-to-upgrade-supported-versions"><bdi class="secno">3.5<!---0.024474%--> </bdi>How to upgrade supported versions</h3><a class="self-link" href="#how-to-upgrade-supported-versions" aria-label="Permalink for Section 3.5"></a></div>


<p>The HTTP Signatures standard has made a few backward-incompatible changes on its path to becoming a full Proposed Standard, [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc9421" title="HTTP Message Signatures">RFC9421<!---0.024474%--></a></cite><!---0.024474%-->].
 Many fediverse servers currently handle older versions of the standard
and aren't yet compatible with the final version. Here's advice on how
to implement HTTP Signatures so as to be compatible with as many
different servers as possible.</p>
<p>The primary technique we recommend is <em>double-knocking</em>.
First, try generating or verifying an HTTP Signature with one version,
ideally (but not necessarily) the latest. If the remote server rejects
that signature, eg with an HTTP 401 response, or the incoming signature
doesn't verify, try with another version. Repeat until a signature
passes or you've tried all supported versions.</p>
<p>(Many fediverse servers do process incoming activities asynchronously, <a href="https://socialhub.activitypub.rocks/t/report-errors-in-server-processing/3006/13">but they generally still <em>verify signatures</em> synchronously</a>, so double knocking is still viable when delivering activities to remote inboxes.)</p>
<p>Here's a list of ways to check for different versions, in descending order:</p>
<ul>
<li>Does the request have the <a href="https://datatracker.ietf.org/doc/html/rfc9421#name-the-signature-input-http-fi"><code>Signature-Input</code> HTTP header</a>? This was only added in the later versions of the standard, notably after <a href="https://datatracker.ietf.org/doc/html/draft-cavage-http-signatures-12"><code>cavage-12</code></a>. <a href="https://datatracker.ietf.org/doc/html/rfc9421#appendix-A">The RFC itself advises this in its appendix on backward compatibility.</a> If <code>Signature-Input</code> is present, and the signature fails, try removing it and using <code>cavage-12</code> instead.</li>
<li>Does the signature use the <code>hs2019</code> placeholder algorithm? This was added in <code>cavage-12</code>, then removed again in later versions. <a href="https://datatracker.ietf.org/doc/html/rfc9421#iana-hsa-contents">It's not present in the final proposed standard.</a> If the signature uses <code>hs2019</code> and fails, try again with <code>rsa-sha256</code>.</li>
<li>Does the signature include the <code>(request-target)</code>, <code>(created)</code>, or  <code>(expires)</code> pseudo-headers? If so, and the signature fails, try replacing them with the <code>Date</code> and/or <code>Host</code> headers.</li>
</ul>
<annost-note>
  Make sure tests tolerate double-knocking (or perhaps more than double).
 </annost-note>
      </section>

    <section id="key-rotation"><div class="header-wrapper"><h3 id="x3-6-key-rotation"><bdi class="secno">3.6<!---0.024474%--> </bdi>Key rotation</h3><a class="self-link" href="#key-rotation" aria-label="Permalink for Section 3.6"></a></div>


<p>Keys don't always stay the same forever. Changing an actor's key is called <em>key rotation</em>,
 and can be a good idea to improve or maintain security in a number of
situations. If a private key is leaked or compromised, you should
immediately stop using it and switch to a new key instead. You can also
do this proactively, regularly, in case of a leak or compromise that you
 haven't discovered yet. Or the key may have been lost, and can't be
restored from backup.</p>
<p><a href="https://socialhub.activitypub.rocks/t/key-rotation-notification/562">There are two common types of key rotation in the fediverse</a>: <em>signed</em>, where you send an <code>Update</code> activity for the actor with the new key to all followers, and <em>blind</em>, where you don't, for plausible deniability of past activities.</p>
<p><a href="#how-to-verify-a-signature" data-matched-text="[[[#how-to-verify-a-signature]]]" class="sec-ref"><bdi class="secno">2.2 </bdi>How to verify a signature</a> step 10 mentions how to handle key rotation when you're verifying a signature. RFC9421 discusses key rotation briefly in <a href="https://datatracker.ietf.org/doc/html/rfc9421#section-7.3.2"><em>7.3.2 Key theft</em></a> and <a href="https://datatracker.ietf.org/doc/html/rfc9421#section-8.1"><em>8.1. Identification through Keys</em></a>.</p>
<annost-note>
Given we can't identify instance actors, we cannot test whether they can, too, because we don't want non-instance actors
to be able to delete on accounts other than their own.
</annost-note>

    </section>

    </section>

    <section id="so-what-s-the-verdict"><!--OddPage--><div class="header-wrapper"><h2 id="x4-so-what-s-the-verdict"><bdi class="secno">4.<!---0.024474%--> </bdi>So, what's the verdict?</h2><a class="self-link" href="#so-what-s-the-verdict" aria-label="Permalink for Section 4."></a></div>


<p>The ActivityPub standard briefly mentions authentication (and
authorization), but omits specific needs or use cases for them. Over
time, two clear uses for authentication in the fediverse have emerged.</p>
<p>The first is proving and verifying that a given user created a given
piece of data or performed a given action. This is the classic
attribution problem in identity-based networks. (Note that this is
separate from authorization or access control, ie determining whether a
given user is <em>allowed</em> to access a given piece of data or perform a given action.)</p>
<p>At a baseline level, this works. HTTP Signatures attached to
ActivityPub inbox delivery requests can effectively verify the actor -
or at least the server - who sent them. However, these signatures are
ephemeral. They only authenticate HTTP requests, not long-lived data.
We'd often like to authenticate objects and activities outside of inbox
delivery requests, eg during <a href="https://www.w3.org/TR/activitypub/#inbox-forwarding">inbox forwarding</a>, or after they were initially created. HTTP Signatures can't do this.</p>
<p>Some fediverse projects like Mastodon use <a href="https://web.archive.org/web/20170923124140/https://w3c-dvcg.github.io/ld-signatures/">LD Signatures 1.0</a>
 for those purposes instead, which works, but isn't widely supported.
Even Mastodon's support itself is limited and discouraged. <a href="https://docs.joinmastodon.org/spec/security/#ld">From their docs</a>:</p>
<blockquote>
Mastodon‚Äôs current implementation of LD Signatures is
outdated...Furthermore, the LD Signatures specification as a whole has
been superseded by <cite><a data-cite="vc-data-integrity" data-matched-text="[[[vc-data-integrity]]]" href="https://www.w3.org/TR/vc-data-integrity/">Verifiable Credential Data Integrity 1.0</a></cite>,
 which is largely incompatible with the earlier LD Signature spec. For
this reason, it is not advised to implement support for LD Signatures.
</blockquote>
<p>The second use case for authentication is access control,
specifically whether to serve an ActivityPub GET request for a given
object or activity. Fediverse users and servers routinely block other
remote users and servers, and require <a href="#authorized-fetch" data-matched-text="[[[#authorized-fetch]]]" class="sec-ref"><bdi class="secno">3.1 </bdi>Authorized fetch</a> via HTTP Signatures to identify the remote user making the request to determine whether they're blocked.</p>
<p>Fediverse servers prevent <em>interactions</em> from blocked
users/servers via the first use case above: they use HTTP Signatures to
identify the remote user, then check if they're blocked. This works,
more or less.</p>
<p>As for <em>controlling access</em> to non-public data, eg direct
messages and followers-only posts, those are only delivered to the
intended recipients' servers, which are expected to only serve them to
authorized users. This matches the fediverse's server-centric security
model.</p>
<p>Otherwise, as a mechanism for controlling access to <em>public</em>
data, HTTP Signatures are only minimally effective, if at all. This
isn't a criticism as much as an unavoidable reality. Fediverse servers
generally serve public data over the web freely, for anyone to see
without logging in or fetching via ActivityPub or HTTP Signature.
There's no obvious way to serve public data to anonymous,
unauthenticated users, and still block access to specific people. Beyond
 that, we've seen <a href="https://wedistribute.org/2023/12/authorized-fetch-circumvented/">techniques that circumvent authorized fetch</a> by laundering requests from blocked servers with signatures from other "clean" (non-blocked) server domains.</p>
<p>The conclusion seems to be that HTTP Signatures do serve real use
cases in the fediverse, to some degree, but not well, and they're not a
solid basis for comprehensive authentication or authorization.</p>
    </section>


<section id="references" class="appendix"><!--OddPage--><div class="header-wrapper"><h2 id="a-references"><bdi class="secno">A.<!---0.024474%--> </bdi>References<!---0.024474%--></h2><a class="self-link" href="#references" aria-label="Permalink for Appendix A."></a></div><section id="informative-references"><div class="header-wrapper"><h3 id="a-1-informative-references"><bdi class="secno">A.1<!---0.024474%--> </bdi>Informative references<!---0.024474%--></h3><a class="self-link" href="#informative-references" aria-label="Permalink for Appendix A.1"></a></div>

    <dl class="bibliography"><dt id="bib-activitypub">[ActivityPub<!---0.024474%-->]</dt><dd>
      <a href="https://www.w3.org/TR/activitypub/"><cite>ActivityPub</cite></a>. Christopher Webber; Jessica Tallon.  W3C. 23 January 2018. W3C Recommendation. URL: <a href="https://www.w3.org/TR/activitypub/">https://www.w3.org/TR/activitypub/</a><!---0.024474%-->
    </dd><dt id="bib-activitystreams-core">[activitystreams-core<!---0.024474%-->]</dt><dd>
      <a href="https://www.w3.org/TR/activitystreams-core/"><cite>Activity Streams 2.0</cite></a>. James Snell; Evan Prodromou.  W3C. 23 May 2017. W3C Recommendation. URL: <a href="https://www.w3.org/TR/activitystreams-core/">https://www.w3.org/TR/activitystreams-core/</a><!---0.024474%-->
    </dd><dt id="bib-http-signatures">[http-signatures<!---0.024474%-->]</dt><dd>
      <a href="https://datatracker.ietf.org/doc/html/draft-cavage-http-signatures"><cite>HTTP Signatures</cite></a>. Mark Cavage; Manu Sporny.  IETF. 4 May 2013. W3C Working Draft. URL: <a href="https://datatracker.ietf.org/doc/html/draft-cavage-http-signatures">https://datatracker.ietf.org/doc/html/draft-cavage-http-signatures</a><!---0.024474%-->
    </dd><dt id="bib-indieauth">[IndieAuth<!---0.024474%-->]</dt><dd>
      <a href="https://www.w3.org/TR/indieauth/"><cite>IndieAuth</cite></a>. Aaron Parecki.  W3C. 23 January 2018. W3C Working Group Note. URL: <a href="https://www.w3.org/TR/indieauth/">https://www.w3.org/TR/indieauth/</a><!---0.024474%-->
    </dd><dt id="bib-rfc3230">[RFC3230<!---0.024474%-->]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc3230"><cite>Instance Digests in HTTP</cite></a>. J. Mogul; A. Van Hoff.  IETF. January 2002. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc3230">https://www.rfc-editor.org/rfc/rfc3230</a><!---0.024474%-->
    </dd><dt id="bib-rfc6749">[RFC6749<!---0.024474%-->]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc6749"><cite>The OAuth 2.0 Authorization Framework</cite></a>. D. Hardt, Ed..  IETF. October 2012. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc6749">https://www.rfc-editor.org/rfc/rfc6749</a><!---0.024474%-->
    </dd><dt id="bib-rfc9421">[RFC9421<!---0.024474%-->]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc9421"><cite>HTTP Message Signatures</cite></a>. A. Backman, Ed.; J. Richer, Ed.; M. Sporny.  IETF. February 2024. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc9421">https://www.rfc-editor.org/rfc/rfc9421</a><!---0.024474%-->
    </dd><dt id="bib-vc-data-integrity">[vc-data-integrity<!---0.024474%-->]</dt><dd>
      <a href="https://www.w3.org/TR/vc-data-integrity/"><cite>Verifiable Credential Data Integrity 1.0</cite></a>.
 Manu Sporny; Dave Longley; Greg Bernstein; Dmitri Zagidulin; Sebastian
Crane.  W3C. 15 March 2024. W3C Candidate Recommendation. URL: <a href="https://www.w3.org/TR/vc-data-integrity/">https://www.w3.org/TR/vc-data-integrity/</a><!---0.024474%-->
    </dd><!---0.024474%--></dl>
  </section></section><p role="navigation" id="back-to-top">
    <a href="#title"><abbr title="Back to Top">‚Üë</abbr></a>
  </p><script id="respec-dfn-panel">(() => {
// @ts-check
if (document.respec) {
  document.respec.ready.then(setupPanel);
} else {
  setupPanel();
}

function setupPanel() {
  const listener = panelListener();
  document.body.addEventListener("keydown", listener);
  document.body.addEventListener("click", listener);
}

function panelListener() {
  /** @type {HTMLElement} */
  let panel = null;
  return event => {
    const { target, type } = event;

    if (!(target instanceof HTMLElement)) return;

    // For keys, we only care about Enter key to activate the panel
    // otherwise it's activated via a click.
    if (type === "keydown" && event.key !== "Enter") return;

    const action = deriveAction(event);

    switch (action) {
      case "show": {
        hidePanel(panel);
        /** @type {HTMLElement} */
        const dfn = target.closest("dfn, .index-term");
        panel = document.getElementById(`dfn-panel-for-${dfn.id}`);
        const coords = deriveCoordinates(event);
        displayPanel(dfn, panel, coords);
        break;
      }
      case "dock": {
        panel.style.left = null;
        panel.style.top = null;
        panel.classList.add("docked");
        break;
      }
      case "hide": {
        hidePanel(panel);
        panel = null;
        break;
      }
    }
  };
}

/**
 * @param {MouseEvent|KeyboardEvent} event
 */
function deriveCoordinates(event) {
  const target = /** @type HTMLElement */ (event.target);

  // We prevent synthetic AT clicks from putting
  // the dialog in a weird place. The AT events sometimes
  // lack coordinates, so they have clientX/Y = 0
  const rect = target.getBoundingClientRect();
  if (
    event instanceof MouseEvent &&
    event.clientX >= rect.left &&
    event.clientY >= rect.top
  ) {
    // The event probably happened inside the bounding rect...
    return { x: event.clientX, y: event.clientY };
  }

  // Offset to the middle of the element
  const x = rect.x + rect.width / 2;
  // Placed at the bottom of the element
  const y = rect.y + rect.height;
  return { x, y };
}

/**
 * @param {Event} event
 */
function deriveAction(event) {
  const target = /** @type {HTMLElement} */ (event.target);
  const hitALink = !!target.closest("a");
  if (target.closest("dfn:not([data-cite]), .index-term")) {
    return hitALink ? "none" : "show";
  }
  if (target.closest(".dfn-panel")) {
    if (hitALink) {
      return target.classList.contains("self-link") ? "hide" : "dock";
    }
    const panel = target.closest(".dfn-panel");
    return panel.classList.contains("docked") ? "hide" : "none";
  }
  if (document.querySelector(".dfn-panel:not([hidden])")) {
    return "hide";
  }
  return "none";
}

/**
 * @param {HTMLElement} dfn
 * @param {HTMLElement} panel
 * @param {{ x: number, y: number }} clickPosition
 */
function displayPanel(dfn, panel, { x, y }) {
  panel.hidden = false;
  // distance (px) between edge of panel and the pointing triangle (caret)
  const MARGIN = 20;

  const dfnRects = dfn.getClientRects();
  // Find the `top` offset when the `dfn` can be spread across multiple lines
  let closestTop = 0;
  let minDiff = Infinity;
  for (const rect of dfnRects) {
    const { top, bottom } = rect;
    const diffFromClickY = Math.abs((top + bottom) / 2 - y);
    if (diffFromClickY < minDiff) {
      minDiff = diffFromClickY;
      closestTop = top;
    }
  }

  const top = window.scrollY + closestTop + dfnRects[0].height;
  const left = x - MARGIN;
  panel.style.left = `${left}px`;
  panel.style.top = `${top}px`;

  // Find if the panel is flowing out of the window
  const panelRect = panel.getBoundingClientRect();
  const SCREEN_WIDTH = Math.min(window.innerWidth, window.screen.width);
  if (panelRect.right > SCREEN_WIDTH) {
    const newLeft = Math.max(MARGIN, x + MARGIN - panelRect.width);
    const newCaretOffset = left - newLeft;
    panel.style.left = `${newLeft}px`;
    /** @type {HTMLElement} */
    const caret = panel.querySelector(".caret");
    caret.style.left = `${newCaretOffset}px`;
  }

  // As it's a dialog, we trap focus.
  // TODO: when <dialog> becomes a implemented, we should really
  // use that.
  trapFocus(panel, dfn);
}

/**
 * @param {HTMLElement} panel
 * @param {HTMLElement} dfn
 * @returns
 */
function trapFocus(panel, dfn) {
  /** @type NodeListOf<HTMLAnchorElement> elements */
  const anchors = panel.querySelectorAll("a[href]");
  // No need to trap focus
  if (!anchors.length) return;

  // Move focus to first anchor element
  const first = anchors.item(0);
  first.focus();

  const trapListener = createTrapListener(anchors, panel, dfn);
  panel.addEventListener("keydown", trapListener);

  // Hiding the panel releases the trap
  const mo = new MutationObserver(records => {
    const [record] = records;
    const target = /** @type HTMLElement */ (record.target);
    if (target.hidden) {
      panel.removeEventListener("keydown", trapListener);
      mo.disconnect();
    }
  });
  mo.observe(panel, { attributes: true, attributeFilter: ["hidden"] });
}

/**
 *
 * @param {NodeListOf<HTMLAnchorElement>} anchors
 * @param {HTMLElement} panel
 * @param {HTMLElement} dfn
 * @returns
 */
function createTrapListener(anchors, panel, dfn) {
  const lastIndex = anchors.length - 1;
  let currentIndex = 0;
  return event => {
    switch (event.key) {
      // Hitting "Tab" traps us in a nice loop around elements.
      case "Tab": {
        event.preventDefault();
        currentIndex += event.shiftKey ? -1 : +1;
        if (currentIndex < 0) {
          currentIndex = lastIndex;
        } else if (currentIndex > lastIndex) {
          currentIndex = 0;
        }
        anchors.item(currentIndex).focus();
        break;
      }

      // Hitting "Enter" on an anchor releases the trap.
      case "Enter":
        hidePanel(panel);
        break;

      // Hitting "Escape" returns focus to dfn.
      case "Escape":
        hidePanel(panel);
        dfn.focus();
        return;
    }
  };
}

/** @param {HTMLElement} panel */
function hidePanel(panel) {
  if (!panel) return;
  panel.hidden = true;
  panel.classList.remove("docked");
}
})()</script><script src="ActivityPub%20and%20HTTP%20Signatures_files/fixup.js"></script></body></html>